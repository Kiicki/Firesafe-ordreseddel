<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Firesafe Ordreseddel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background: #f0f0f0;
            font-size: 12px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Toolbar - only visible on screen */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 2px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .toolbar button {
            flex: 1 1 calc(33.333% - 6px);
            max-width: calc(33.333% - 6px);
            padding: 11px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: #495057;
            color: white;
            transition: all 0.15s ease;
        }

        .toolbar button:hover {
            background: #343a40;
        }

        .toolbar button:active {
            transform: translateY(1px);
        }

        .btn-pdf { }
        .btn-jpg { }
        .btn-load { }
        .btn-archive { background: #6c757d; }
        .btn-new { }

        .btn-save {
            background: #198754;
        }

        .btn-save:hover {
            background: #157347;
        }

        /* Form container - the actual form that looks like the original */
        .form-container {
            background: white;
            border: 1px solid #000;
            border-bottom: none;
            overflow: visible;
        }

        /* Header section */
        .header {
            display: flex;
            border-bottom: 1px solid #000;
            overflow: visible;
        }

        .header-left {
            flex: 1;
            padding: 26px 15px 10px 25px;
        }

        .logo {
            font-size: 26px;
            font-weight: 900;
            color: #000;
            font-family: Arial Black, Arial, sans-serif;
            position: relative;
            display: inline-block;
            letter-spacing: 1px;
            padding-right: 25px;
            padding-bottom: 15px;
        }

        .logo-slash {
            position: absolute;
            right: 14px;
            top: 10px;
            width: 4px;
            height: 52px;
            background: #000;
            transform: skewX(-22deg);
        }

        .header-right {
            flex: 1;
            padding: 0;
            font-size: 11px;
            line-height: 1.4;
            text-align: center;
            overflow: visible;
        }

        .ordreseddel-nr-row {
            background: transparent;
            color: #000;
            padding: 8px 15px 6px 50px;
            font-size: 11px;
            display: flex;
            align-items: baseline;
            justify-content: center;
        }

        .ordreseddel-nr-label {
            font-size: 17px;
            white-space: nowrap;
            font-weight: bold;
            margin-right: 10px;
        }

        .ordreseddel-nr-row input {
            background: transparent;
            border: none;
            color: #c00;
            width: 150px;
            font-size: 28px;
            font-weight: normal;
            letter-spacing: 3px;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
            direction: ltr;
            transform: none;
            -webkit-transform: none;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            unicode-bidi: normal;
            line-height: 1;
        }

        .header-right-info {
            padding: 0 15px 8px 85px;
            margin-top: -6px;
            font-size: 11px;
            display: grid;
            grid-template-columns: auto auto;
            gap: 0 10px;
            text-align: left;
            justify-content: center;
        }

        .header-right-info .left {
            text-align: right;
        }

        .header-right-info .right {
            text-align: left;
        }

        /* Main form rows */
        .form-row {
            display: flex;
            border-bottom: 1px solid #000;
        }

        .form-cell {
            padding: 0;
            border-right: 1px solid #000;
            flex: 1;
        }

        .form-cell:last-child {
            border-right: none;
        }

        .form-cell.small {
            flex: 0 0 200px;
        }

        .form-cell.medium {
            flex: 0 0 150px;
        }

        .cell-label {
            font-size: 10px;
            color: #000;
            padding: 2px 8px 2px 25px;
        }

        .cell-label.gray {
            background: #d0d0d0;
        }

        .cell-input {
            padding: 0;
        }

        .cell-input input,
        .cell-input textarea {
            width: 100%;
            border: none;
            padding: 6px 8px 6px 25px;
            font-size: 14px;
            font-family: inherit;
            -webkit-appearance: none;
            background: transparent;
        }

        .cell-input input:focus,
        .cell-input textarea:focus {
            outline: none;
            background: #ffffd0;
        }


        /* Work description section */
        .work-header {
            display: flex;
            background: #777777;
            color: #fff;
            font-size: 11px;
            font-weight: bold;
        }

        .work-header-desc {
            flex: 1;
            padding: 10px 10px;
            border-right: 1px solid #000;
            text-align: center;
        }

        .work-header-antall {
            width: 100px;
            padding: 10px 10px;
            text-align: center;
            border-right: 1px solid #000;
        }

        .work-header-enhet {
            width: 100px;
            padding: 10px 10px;
            text-align: center;
        }

        .work-lines {
        }

        .work-line {
            display: flex;
            border-bottom: 1px solid #000;
            min-height: 42px;
        }

        .work-line-desc {
            flex: 1;
            border-right: 1px solid #000;
            display: flex;
            flex-direction: column;
            min-height: 42px;
        }

        .work-line-desc textarea.work-description {
            width: 100%;
            border: none;
            padding: 8px 8px 4px 25px;
            font-size: 14px;
            font-family: inherit;
            -webkit-appearance: none;
            resize: none;
            overflow: visible;
            min-height: 24px;
            line-height: 1.4;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            box-sizing: border-box;
            display: block;
        }

        .work-line-desc textarea.work-description:focus {
            outline: none;
            background: #ffffd0;
        }

        .work-line-desc textarea.work-material {
            width: 100%;
            border: none;
            border-top: 1px dashed #ccc;
            padding: 4px 8px 4px 25px;
            font-size: 11px;
            font-family: inherit;
            font-style: italic;
            color: #555;
            -webkit-appearance: none;
            resize: none;
            overflow: visible;
            min-height: 18px;
            line-height: 1.4;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            box-sizing: border-box;
            display: block;
        }

        .work-line-desc textarea.work-material:focus {
            outline: none;
            background: #ffffd0;
        }

        /* Converted textarea to div for export */
        .work-line-desc .textarea-converted {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: visible;
        }

        .work-line-desc .textarea-converted.work-description {
            width: 100%;
            border: none;
            padding: 8px 8px 4px 25px;
            font-size: 14px;
            font-family: Arial, sans-serif;
            min-height: 24px;
            line-height: 1.4;
            box-sizing: border-box;
        }

        .work-line-desc .textarea-converted.work-material {
            width: 100%;
            border: none;
            border-top: 1px dashed #ccc;
            padding: 4px 8px 4px 25px;
            font-size: 11px;
            font-family: Arial, sans-serif;
            font-style: italic;
            color: #555;
            min-height: 18px;
            line-height: 1.4;
            box-sizing: border-box;
        }

        .work-line-antall {
            width: 100px;
            border-right: 1px solid #000;
        }

        .work-line-antall input {
            width: 100%;
            border: none;
            padding: 8px;
            font-size: 14px;
            text-align: center;
            -webkit-appearance: none;
        }

        .work-line-antall input:focus {
            outline: none;
            background: #ffffd0;
        }

        .work-line-enhet {
            width: 100px;
        }

        .work-line-enhet input {
            width: 100%;
            border: none;
            padding: 8px;
            font-size: 14px;
            text-align: center;
            -webkit-appearance: none;
        }

        .work-line-enhet input:focus {
            outline: none;
            background: #ffffd0;
        }

        /* Footer section */
        .footer-row {
            display: flex;
            gap: 40px;
            padding: 0 40px;
            margin-top: 10px;
        }

        .footer-cell {
            flex: 2;
        }

        .footer-cell:nth-child(2) {
            flex: 1;
        }

        .signature-cell {
            display: flex;
            flex-direction: column;
        }

        .signature-input {
            flex: 1;
            min-height: 30px;
        }

        .signature-input input {
            width: 100%;
            border: none;
            border-bottom: 1px solid #000;
            padding: 6px 8px;
            font-size: 14px;
            font-family: inherit;
            background: transparent;
            text-align: center;
        }

        .signature-input input:focus {
            outline: none;
            background: #ffffd0;
        }

        .signature-label {
            font-size: 10px;
            padding: 2px 8px;
            text-align: center;
        }

        .footer-bottom {
            display: flex;
            font-size: 10px;
            padding: 4px 40px;
        }

        .footer-bottom-left {
            flex: 1;
            font-weight: bold;
        }

        .footer-bottom-right {
            text-align: right;
            font-weight: bold;
        }

        .footer-staples {
            text-align: center;
            font-size: 10px;
            padding: 8px;
            color: #000;
        }

        .staples-nr {
            font-size: 6px;
            color: #666;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: white;
            max-width: 500px;
            margin: 20px auto;
            border-radius: 8px;
            overflow: hidden;
        }

        .modal-header {
            background: #333;
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-search {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .modal-search input:focus {
            border-color: #1abc9c;
        }

        .saved-item {
            padding: 14px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            transition: all 0.15s ease;
            gap: 12px;
        }

        .saved-item:hover {
            background: #f8f9fa;
            border-color: #1abc9c;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .saved-item-info {
            flex: 1;
            min-width: 0;
        }

        .saved-item-row1 {
            font-weight: 600;
            font-size: 15px;
            color: #222;
        }

        .saved-item-row2 {
            color: #777;
            font-size: 13px;
        }

        .saved-item-row3 {
            color: #1abc9c;
            font-size: 13px;
            font-weight: 600;
        }

        .saved-item-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .saved-item-delete {
            padding: 8px 12px;
            background: transparent;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .saved-item-delete:hover {
            background: #e74c3c;
            color: white;
        }

        .saved-item-archive {
            padding: 8px 12px;
            background: transparent;
            color: #1abc9c;
            border: 1px solid #1abc9c;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .saved-item-archive:hover {
            background: #1abc9c;
            color: white;
        }

        .saved-item-restore {
            padding: 8px 12px;
            background: transparent;
            color: #3498db;
            border: 1px solid #3498db;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .saved-item-restore:hover {
            background: #3498db;
            color: white;
        }

        .saved-item-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .saved-item-icon-btn.archive {
            color: #1abc9c;
            border-color: #1abc9c;
        }

        .saved-item-icon-btn.archive:hover {
            background: #1abc9c;
            color: white;
        }

        .saved-item-icon-btn.restore {
            color: #3498db;
            border-color: #3498db;
        }

        .saved-item-icon-btn.restore:hover {
            background: #3498db;
            color: white;
        }

        .saved-item-icon-btn.delete {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .saved-item-icon-btn.delete:hover {
            background: #e74c3c;
            color: white;
        }

        .no-saved {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            font-size: 18px;
        }

        .loading.active {
            display: flex;
        }

        /* Hide buttons on export */
        @media print {
            .toolbar, .modal {
                display: none !important;
            }
            body {
                background: white;
                padding: 0;
            }
        }

        /* Mobile form - hidden on desktop */
        .mobile-form {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 2px 15px 5px 15px;
            padding-bottom: 150px; /* Ekstra plass for mobil-tastatur */
        }

        .mobile-form-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e74c3c;
        }

        .mobile-form-header h1 {
            font-size: 24px;
            font-weight: 900;
            margin: 0 0 5px 0;
            color: #000;
            position: relative;
            display: inline-block;
            padding-right: 18px;
        }

        .mobile-logo-slash {
            position: absolute;
            right: 2px;
            top: 9px;
            width: 3px;
            height: 48px;
            background: #000;
            transform: skewX(-22deg);
        }

        .mobile-form-header p {
            font-size: 12px;
            color: #666;
            margin: 0;
        }

        .mobile-section {
            margin-bottom: 20px;
        }

        .mobile-section-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .mobile-field {
            margin-bottom: 12px;
        }

        .mobile-field label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #555;
            margin-bottom: 4px;
        }

        .mobile-field input,
        .mobile-field textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
            -webkit-appearance: none;
        }

        .mobile-field input:focus,
        .mobile-field textarea:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
        }

        .mobile-work-line {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .mobile-work-line-header {
            font-size: 11px;
            font-weight: bold;
            color: #888;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-work-line .mobile-field {
            margin-bottom: 8px;
        }

        .mobile-work-line .mobile-field:last-child {
            margin-bottom: 0;
        }

        .mobile-work-row {
            display: flex;
            gap: 10px;
        }

        .mobile-work-row .mobile-field {
            flex: 1;
        }

        .mobile-add-line-btn {
            width: 100%;
            padding: 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .mobile-add-line-btn:active {
            opacity: 0.8;
        }

        .mobile-work-line {
            display: none;
        }

        .mobile-work-line.visible {
            display: block;
        }

        .mobile-work-line-remove {
            width: 44px;
            height: 44px;
            border: none;
            background: transparent;
            color: #e74c3c;
            font-size: 20px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: -8px;
        }

        .mobile-work-line-remove:active {
            color: #c0392b;
        }

        .mobile-work-line-remove:disabled {
            color: #ccc;
            pointer-events: none;
        }

        .mobile-work-line-remove svg {
            pointer-events: none;
        }

        /* Confirmation modal */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 300px;
            text-align: center;
            margin: 20px;
        }

        .confirm-modal-text {
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .confirm-btn-cancel {
            flex: 1;
            padding: 12px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .confirm-btn-cancel:active {
            background: #f5f5f5;
        }

        .confirm-btn-ok {
            flex: 1;
            padding: 12px;
            border: none;
            background: #e74c3c;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .confirm-btn-ok:active {
            background: #c0392b;
        }

        /* Notification modal */
        .notification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .notification-modal.active {
            display: flex;
        }

        .notification-modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 300px;
            text-align: center;
            margin: 20px;
        }

        .notification-modal-text {
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
        }

        .notification-btn-ok {
            width: 100%;
            padding: 12px;
            border: none;
            background: #1abc9c;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .notification-btn-ok:active {
            background: #16a085;
        }

        /* Mobile responsive - show mobile form, hide original */
        @media screen and (max-width: 600px) {
            body {
                padding: 5px;
            }

            .mobile-form {
                display: block;
            }

            .form-container {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Genererer fil...</div>

    <div class="container">
        <div class="toolbar">
            <button class="btn-new" onclick="newForm()">Ny</button>
            <button class="btn-save" onclick="saveForm()">Lagre</button>
            <button class="btn-load" onclick="showSavedForms()">Hent</button>
            <button class="btn-pdf" onclick="exportPDF()">PDF</button>
            <button class="btn-jpg" onclick="exportJPG()">JPG</button>
            <button class="btn-archive" onclick="showArchivedForms()">Arkiv</button>
        </div>

        <!-- Mobile-friendly input form (visible on mobile only) -->
        <div class="mobile-form" id="mobile-form">
            <div class="mobile-form-header">
                <h1>FIRESAFE<span class="mobile-logo-slash"></span></h1>
                <p>Ordreseddel</p>
            </div>

            <div class="mobile-section">
                <div class="mobile-section-title">Grunninfo</div>
                <div class="mobile-field">
                    <label>Ordreseddel nr.</label>
                    <input type="text" id="mobile-ordreseddel-nr" inputmode="numeric" >
                </div>
                <div class="mobile-field">
                    <label>Dato</label>
                    <input type="text" id="mobile-dato">
                </div>
            </div>

            <div class="mobile-section">
                <div class="mobile-section-title">Kunde</div>
                <div class="mobile-field">
                    <label>Oppdragsgiver</label>
                    <input type="text" id="mobile-oppdragsgiver">
                </div>
                <div class="mobile-field">
                    <label>Kundens ref.</label>
                    <input type="text" id="mobile-kundens-ref">
                </div>
                <div class="mobile-field">
                    <label>Fakturaadresse</label>
                    <input type="text" id="mobile-fakturaadresse">
                </div>
            </div>

            <div class="mobile-section">
                <div class="mobile-section-title">Prosjekt</div>
                <div class="mobile-field">
                    <label>Prosjektnr.</label>
                    <input type="text" id="mobile-prosjektnr">
                </div>
                <div class="mobile-field">
                    <label>Prosjektnavn</label>
                    <input type="text" id="mobile-prosjektnavn">
                </div>
                <div class="mobile-field">
                    <label>Montør</label>
                    <input type="text" id="mobile-montor">
                </div>
                <div class="mobile-field">
                    <label>Avdeling</label>
                    <input type="text" id="mobile-avdeling">
                </div>
            </div>

            <div class="mobile-section">
                <div class="mobile-section-title">Utførte arbeider</div>
                <div id="mobile-work-lines">
                    <div class="mobile-work-line visible">
                        <div class="mobile-work-line-header"><span>Linje 1</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)" disabled><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 2</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 3</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 4</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 5</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 6</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 7</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 8</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 9</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 10</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 11</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 12</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 13</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 14</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                    <div class="mobile-work-line">
                        <div class="mobile-work-line-header"><span>Linje 15</span><button type="button" class="mobile-work-line-remove" onclick="removeMobileLine(this)"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
                        <div class="mobile-field">
                            <label>Beskrivelse</label>
                            <input type="text" class="mobile-work-desc">
                        </div>
                        <div class="mobile-field">
                            <label>Material</label>
                            <input type="text" class="mobile-work-material" >
                        </div>
                        <div class="mobile-work-row">
                            <div class="mobile-field">
                                <label>Antall</label>
                                <input type="text" class="mobile-work-antall" inputmode="numeric">
                            </div>
                            <div class="mobile-field">
                                <label>Enhet</label>
                                <input type="text" class="mobile-work-enhet">
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="mobile-add-line-btn" onclick="addMobileLine()">+ Legg til linje</button>
            </div>

            <div class="mobile-section">
                <div class="mobile-section-title">Signering</div>
                <div class="mobile-field">
                    <label>Sted</label>
                    <input type="text" id="mobile-sted">
                </div>
                <div class="mobile-field">
                    <label>Dato</label>
                    <input type="text" id="mobile-signering-dato">
                </div>
                <div class="mobile-field">
                    <label>Kundens underskrift</label>
                    <input type="text" id="mobile-kundens-underskrift">
                </div>
            </div>
        </div>

        <div class="form-container" id="form-container">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <div class="logo">
                        FIRESAFE<div class="logo-slash"></div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="ordreseddel-nr-row">
                        <span class="ordreseddel-nr-label">Ordreseddel nr.:</span>
                        <input type="text" id="ordreseddel-nr" >
                    </div>
                    <div class="header-right-info">
                        <span class="left" style="font-weight: bold; font-size: 13px;">FIRESAFE AS</span><span class="right" style="font-weight: bold; font-size: 13px;">HOVEDKONTOR</span>
                        <span class="left">Postadresse</span><span class="right">Postboks 6411 Etterstad</span>
                        <span class="left"></span><span class="right">0605 Oslo</span>
                        <span class="left">Telefon</span><span class="right">09110</span>
                    </div>
                </div>
            </div>

            <!-- Oppdragsgiver / Kundens ref -->
            <div class="form-row">
                <div class="form-cell">
                    <div class="cell-label">Oppdragsgiver</div>
                    <div class="cell-input">
                        <input type="text" id="oppdragsgiver">
                    </div>
                </div>
                <div class="form-cell small">
                    <div class="cell-label">Kundens ref.</div>
                    <div class="cell-input">
                        <input type="text" id="kundens-ref">
                    </div>
                </div>
            </div>

            <!-- Fakturaadresse -->
            <div class="form-row">
                <div class="form-cell">
                    <div class="cell-label">Fakturaadresse</div>
                    <div class="cell-input">
                        <input type="text" id="fakturaadresse">
                    </div>
                </div>
            </div>

            <!-- Dato / Prosjektnr / Prosjektnavn -->
            <div class="form-row">
                <div class="form-cell" style="flex: 0 0 50%; display: flex; padding: 0;">
                    <div class="form-cell" style="flex: 0 0 105px; border-right: 1px solid #000;">
                        <div class="cell-label">Dato</div>
                        <div class="cell-input">
                            <input type="text" id="dato">
                        </div>
                    </div>
                    <div class="form-cell" style="flex: 1; border-right: none;">
                        <div class="cell-label">Prosjektnr.</div>
                        <div class="cell-input">
                            <input type="text" id="prosjektnr">
                        </div>
                    </div>
                </div>
                <div class="form-cell" style="flex: 0 0 50%;">
                    <div class="cell-label">Prosjektnavn</div>
                    <div class="cell-input">
                        <input type="text" id="prosjektnavn">
                    </div>
                </div>
            </div>

            <!-- Montør / Avdeling -->
            <div class="form-row">
                <div class="form-cell" style="flex: 1;">
                    <div class="cell-label">Montør</div>
                    <div class="cell-input">
                        <input type="text" id="montor">
                    </div>
                </div>
                <div class="form-cell" style="flex: 1;">
                    <div class="cell-label">Avdeling</div>
                    <div class="cell-input">
                        <input type="text" id="avdeling">
                    </div>
                </div>
            </div>

            <!-- Work description header -->
            <div class="work-header">
                <div class="work-header-desc">Beskrivelse av utforte arbeider</div>
                <div class="work-header-antall">Antall</div>
                <div class="work-header-enhet">Enhet</div>
            </div>

            <!-- Work lines -->
            <div class="work-lines" id="work-lines">
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
                <div class="work-line"><div class="work-line-desc"><textarea class="work-description"></textarea><textarea class="work-material"></textarea></div><div class="work-line-antall"><input type="text" class="work-antall"></div><div class="work-line-enhet"><input type="text" class="work-enhet"></div></div>
            </div>

            <!-- Footer: Sted / Dato / Kundens underskrift -->
            <div class="footer-row">
                <div class="footer-cell signature-cell">
                    <div class="signature-input">
                        <input type="text" id="sted">
                    </div>
                    <div class="signature-label">Sted</div>
                </div>
                <div class="footer-cell signature-cell">
                    <div class="signature-input">
                        <input type="text" id="signering-dato">
                    </div>
                    <div class="signature-label">Dato</div>
                </div>
                <div class="footer-cell signature-cell">
                    <div class="signature-input">
                        <input type="text" id="kundens-underskrift">
                    </div>
                    <div class="signature-label">Kundens underskrift</div>
                </div>
            </div>

            <!-- Bottom text -->
            <div class="footer-bottom">
                <div class="footer-bottom-left">Original: Firesafe</div>
                <div class="footer-bottom-right">Kopi: Kunden</div>
            </div>
            <div class="footer-staples"><span class="staples-nr">42789</span> Staples - Tlf.: 02272</div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-text" id="confirm-modal-text">Er du sikker?</div>
            <div class="confirm-modal-buttons">
                <button class="confirm-btn-cancel" onclick="closeConfirmModal(false)">Avbryt</button>
                <button class="confirm-btn-ok" id="confirm-btn-ok" onclick="closeConfirmModal(true)">Fjern</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="notification-modal" id="notification-modal">
        <div class="notification-modal-content">
            <div class="notification-modal-text" id="notification-modal-text">Skjema lagret!</div>
            <button class="notification-btn-ok" onclick="closeNotificationModal()">OK</button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="saved-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Lagrede skjemaer</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-search">
                <input type="text" id="saved-search" placeholder="Søk ordrenummer..." oninput="filterSavedForms()">
            </div>
            <div class="modal-body" id="saved-list"></div>
        </div>
    </div>

    <div class="modal" id="archive-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Arkiverte skjemaer</span>
                <button class="modal-close" onclick="closeArchiveModal()">&times;</button>
            </div>
            <div class="modal-search">
                <input type="text" id="archive-search" placeholder="Søk ordrenummer..." oninput="filterArchivedForms()">
            </div>
            <div class="modal-body" id="archive-list"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'firesafe_ordresedler';
        const ARCHIVE_KEY = 'firesafe_arkiv';

        // Confirmation modal
        let pendingConfirmAction = null;

        function showConfirmModal(message, onConfirm, buttonText, buttonColor) {
            document.getElementById('confirm-modal-text').textContent = message;
            const okBtn = document.getElementById('confirm-btn-ok');
            okBtn.textContent = buttonText || 'Fjern';
            okBtn.style.backgroundColor = buttonColor || '#e74c3c';
            pendingConfirmAction = onConfirm;
            document.getElementById('confirm-modal').classList.add('active');
        }

        function closeConfirmModal(confirmed) {
            document.getElementById('confirm-modal').classList.remove('active');
            if (confirmed && pendingConfirmAction) {
                pendingConfirmAction();
            }
            pendingConfirmAction = null;
        }

        // Notification modal
        function showNotificationModal(message) {
            document.getElementById('notification-modal-text').textContent = message;
            document.getElementById('notification-modal').classList.add('active');
        }

        function closeNotificationModal() {
            document.getElementById('notification-modal').classList.remove('active');
        }

        // Format today's date as DD.MM.YYYY
        function formatDate(date) {
            const d = date.getDate().toString().padStart(2, '0');
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const y = date.getFullYear();
            return `${d}.${m}.${y}`;
        }

        // Check if we're on mobile
        function isMobile() {
            return window.innerWidth <= 600;
        }

        // Auto-resize textarea to fit content
        function autoResizeTextarea(textarea) {
            // Set minimal height first to force scrollHeight recalculation
            textarea.style.height = '1px';
            textarea.style.overflow = 'hidden';

            // Force reflow
            void textarea.offsetHeight;

            // Set to scrollHeight
            const minHeight = textarea.classList.contains('work-material') ? 18 : 24;
            textarea.style.height = Math.max(textarea.scrollHeight, minHeight) + 'px';
        }

        // Apply auto-resize to all textareas in work-lines
        function initAutoResize() {
            document.querySelectorAll('.work-description, .work-material').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
                // Initial resize
                autoResizeTextarea(textarea);
            });
        }

        // Force resize all textareas (used before export)
        function resizeAllTextareas() {
            document.querySelectorAll('.work-description, .work-material').forEach(textarea => {
                const text = textarea.value;
                if (text && text.length > 0) {
                    // First set a minimal height to force scrollHeight to calculate wrapped content
                    textarea.style.height = '1px';
                    textarea.style.overflow = 'hidden';

                    // Force browser to recalculate layout
                    void textarea.offsetHeight;

                    // Now scrollHeight contains the full height needed for wrapped text
                    const scrollHeight = textarea.scrollHeight;
                    const minHeight = textarea.classList.contains('work-material') ? 18 : 24;
                    textarea.style.height = Math.max(scrollHeight, minHeight) + 'px';
                } else {
                    // Empty textarea - set to min height
                    const minHeight = textarea.classList.contains('work-material') ? 18 : 24;
                    textarea.style.height = minHeight + 'px';
                }
            });
        }

        // Convert textareas to divs for export (divs wrap text properly)
        function convertTextareasToDiv() {
            const convertedElements = [];

            // Convert work description and material textareas
            document.querySelectorAll('#form-container .work-description, #form-container .work-material').forEach(textarea => {
                const div = document.createElement('div');
                div.textContent = textarea.value;
                div.className = textarea.className + ' textarea-converted';

                textarea.style.display = 'none';
                textarea.parentNode.insertBefore(div, textarea.nextSibling);
                convertedElements.push({ original: textarea, replacement: div });
            });

            // Convert ordreseddel-nr input to span (fixes rendering issues with html2canvas)
            const ordreseddelInput = document.getElementById('ordreseddel-nr');
            if (ordreseddelInput) {
                const span = document.createElement('span');
                span.textContent = ordreseddelInput.value;
                span.className = 'ordreseddel-nr-converted';
                span.style.cssText = `
                    color: #c00;
                    font-size: 28px;
                    font-weight: normal;
                    letter-spacing: 3px;
                    font-family: Arial, Helvetica, sans-serif;
                    line-height: 1;
                `;

                ordreseddelInput.style.display = 'none';
                ordreseddelInput.parentNode.insertBefore(span, ordreseddelInput.nextSibling);
                convertedElements.push({ original: ordreseddelInput, replacement: span });
            }

            return convertedElements;
        }

        // Restore textareas after export
        function restoreTextareas(convertedElements) {
            convertedElements.forEach(({ original, replacement }) => {
                original.style.display = '';
                replacement.remove();
            });
        }

        // Update delete button states based on visible lines
        function updateDeleteButtonStates() {
            const visibleLines = document.querySelectorAll('#mobile-work-lines .mobile-work-line.visible');
            const allButtons = document.querySelectorAll('#mobile-work-lines .mobile-work-line-remove');

            // If only one line is visible, disable all delete buttons
            // Otherwise, enable delete buttons on visible lines
            allButtons.forEach((btn, index) => {
                const line = btn.closest('.mobile-work-line');
                if (visibleLines.length <= 1) {
                    btn.disabled = true;
                } else if (line.classList.contains('visible')) {
                    btn.disabled = false;
                }
            });
        }

        // Add another mobile work line (show next hidden line)
        function addMobileLine() {
            const lines = document.querySelectorAll('#mobile-work-lines .mobile-work-line');
            for (let i = 0; i < lines.length; i++) {
                if (!lines[i].classList.contains('visible')) {
                    lines[i].classList.add('visible');
                    // Hide button if all 15 lines are visible
                    if (i === lines.length - 1) {
                        document.querySelector('.mobile-add-line-btn').style.display = 'none';
                    }
                    // Scroll to the new line
                    lines[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    break;
                }
            }
            // Update delete button states
            updateDeleteButtonStates();
        }

        // Remove a mobile work line
        function removeMobileLine(button) {
            showConfirmModal('Er du sikker på at du vil fjerne denne linjen?', function() {
                const line = button.closest('.mobile-work-line');

                // Clear all inputs in this line
                line.querySelectorAll('input').forEach(input => input.value = '');

                // Hide the line
                line.classList.remove('visible');

                // Show the add button again
                document.querySelector('.mobile-add-line-btn').style.display = 'block';

                // Update delete button states
                updateDeleteButtonStates();

                // Sync to original form
                syncMobileToOriginal();

                // Save to session storage
                sessionStorage.setItem('firesafe_current', JSON.stringify(getFormData()));
            });
        }

        // Show mobile lines that have data
        function showMobileLinesWithData() {
            const lines = document.querySelectorAll('#mobile-work-lines .mobile-work-line');
            lines.forEach((line, index) => {
                const desc = line.querySelector('.mobile-work-desc');
                const material = line.querySelector('.mobile-work-material');
                const antall = line.querySelector('.mobile-work-antall');
                const enhet = line.querySelector('.mobile-work-enhet');

                // Show line if it has any data, or if it's the first line
                if (index === 0 || (desc && desc.value) || (material && material.value) || (antall && antall.value) || (enhet && enhet.value)) {
                    line.classList.add('visible');
                }
            });

            // Also show the next empty line after the last filled one
            let lastVisibleIndex = -1;
            lines.forEach((line, index) => {
                if (line.classList.contains('visible')) {
                    lastVisibleIndex = index;
                }
            });
            if (lastVisibleIndex < lines.length - 1) {
                lines[lastVisibleIndex + 1].classList.add('visible');
            }

            // Update button visibility
            const allVisible = Array.from(lines).every(l => l.classList.contains('visible'));
            document.querySelector('.mobile-add-line-btn').style.display = allVisible ? 'none' : 'block';

            // Update delete button states
            updateDeleteButtonStates();
        }

        // Sync mobile form to original form
        function syncMobileToOriginal() {
            // Simple fields
            const fieldMap = {
                'mobile-ordreseddel-nr': 'ordreseddel-nr',
                'mobile-oppdragsgiver': 'oppdragsgiver',
                'mobile-kundens-ref': 'kundens-ref',
                'mobile-fakturaadresse': 'fakturaadresse',
                'mobile-dato': 'dato',
                'mobile-prosjektnr': 'prosjektnr',
                'mobile-prosjektnavn': 'prosjektnavn',
                'mobile-montor': 'montor',
                'mobile-avdeling': 'avdeling',
                'mobile-sted': 'sted',
                'mobile-signering-dato': 'signering-dato',
                'mobile-kundens-underskrift': 'kundens-underskrift'
            };

            for (const [mobileId, originalId] of Object.entries(fieldMap)) {
                const mobileEl = document.getElementById(mobileId);
                const originalEl = document.getElementById(originalId);
                if (mobileEl && originalEl) {
                    originalEl.value = mobileEl.value;
                }
            }

            // Work lines
            const mobileWorkLines = document.querySelectorAll('#mobile-work-lines .mobile-work-line');
            const originalWorkLines = document.querySelectorAll('#work-lines .work-line');

            mobileWorkLines.forEach((mobileLine, index) => {
                if (originalWorkLines[index]) {
                    const mobileDesc = mobileLine.querySelector('.mobile-work-desc');
                    const mobileMaterial = mobileLine.querySelector('.mobile-work-material');
                    const mobileAntall = mobileLine.querySelector('.mobile-work-antall');
                    const mobileEnhet = mobileLine.querySelector('.mobile-work-enhet');

                    const originalDesc = originalWorkLines[index].querySelector('.work-description');
                    const originalMaterial = originalWorkLines[index].querySelector('.work-material');
                    const originalAntall = originalWorkLines[index].querySelector('.work-antall');
                    const originalEnhet = originalWorkLines[index].querySelector('.work-enhet');

                    if (mobileDesc && originalDesc) {
                        originalDesc.value = mobileDesc.value;
                        autoResizeTextarea(originalDesc);
                    }
                    if (mobileMaterial && originalMaterial) {
                        originalMaterial.value = mobileMaterial.value;
                        autoResizeTextarea(originalMaterial);
                    }
                    if (mobileAntall && originalAntall) originalAntall.value = mobileAntall.value;
                    if (mobileEnhet && originalEnhet) originalEnhet.value = mobileEnhet.value;
                }
            });
        }

        // Sync original form to mobile form
        function syncOriginalToMobile() {
            // Simple fields
            const fieldMap = {
                'ordreseddel-nr': 'mobile-ordreseddel-nr',
                'oppdragsgiver': 'mobile-oppdragsgiver',
                'kundens-ref': 'mobile-kundens-ref',
                'fakturaadresse': 'mobile-fakturaadresse',
                'dato': 'mobile-dato',
                'prosjektnr': 'mobile-prosjektnr',
                'prosjektnavn': 'mobile-prosjektnavn',
                'montor': 'mobile-montor',
                'avdeling': 'mobile-avdeling',
                'sted': 'mobile-sted',
                'signering-dato': 'mobile-signering-dato',
                'kundens-underskrift': 'mobile-kundens-underskrift'
            };

            for (const [originalId, mobileId] of Object.entries(fieldMap)) {
                const originalEl = document.getElementById(originalId);
                const mobileEl = document.getElementById(mobileId);
                if (originalEl && mobileEl) {
                    mobileEl.value = originalEl.value;
                }
            }

            // Work lines
            const originalWorkLines = document.querySelectorAll('#work-lines .work-line');
            const mobileWorkLines = document.querySelectorAll('#mobile-work-lines .mobile-work-line');

            originalWorkLines.forEach((originalLine, index) => {
                if (mobileWorkLines[index]) {
                    const originalDesc = originalLine.querySelector('.work-description');
                    const originalMaterial = originalLine.querySelector('.work-material');
                    const originalAntall = originalLine.querySelector('.work-antall');
                    const originalEnhet = originalLine.querySelector('.work-enhet');

                    const mobileDesc = mobileWorkLines[index].querySelector('.mobile-work-desc');
                    const mobileMaterial = mobileWorkLines[index].querySelector('.mobile-work-material');
                    const mobileAntall = mobileWorkLines[index].querySelector('.mobile-work-antall');
                    const mobileEnhet = mobileWorkLines[index].querySelector('.mobile-work-enhet');

                    if (originalDesc && mobileDesc) mobileDesc.value = originalDesc.value;
                    if (originalMaterial && mobileMaterial) mobileMaterial.value = originalMaterial.value;
                    if (originalAntall && mobileAntall) mobileAntall.value = originalAntall.value;
                    if (originalEnhet && mobileEnhet) mobileEnhet.value = originalEnhet.value;
                }
            });
        }



        function getFormData() {
            // If on mobile, sync to original first
            if (isMobile()) {
                syncMobileToOriginal();
            }

            const workLines = [];
            document.querySelectorAll('.work-line').forEach(line => {
                workLines.push({
                    description: line.querySelector('.work-description').value,
                    material: line.querySelector('.work-material').value,
                    antall: line.querySelector('.work-antall').value,
                    enhet: line.querySelector('.work-enhet').value
                });
            });

            return {
                ordreseddelNr: document.getElementById('ordreseddel-nr').value,
                oppdragsgiver: document.getElementById('oppdragsgiver').value,
                kundensRef: document.getElementById('kundens-ref').value,
                fakturaadresse: document.getElementById('fakturaadresse').value,
                dato: document.getElementById('dato').value,
                prosjektnr: document.getElementById('prosjektnr').value,
                prosjektnavn: document.getElementById('prosjektnavn').value,
                montor: document.getElementById('montor').value,
                avdeling: document.getElementById('avdeling').value,
                workLines: workLines,
                sted: document.getElementById('sted').value,
                signeringDato: document.getElementById('signering-dato').value,
                kundensUnderskrift: document.getElementById('kundens-underskrift').value,
                savedAt: new Date().toISOString()
            };
        }

        function setFormData(data) {
            // Set original form data
            document.getElementById('ordreseddel-nr').value = data.ordreseddelNr || '';
            document.getElementById('oppdragsgiver').value = data.oppdragsgiver || '';
            document.getElementById('kundens-ref').value = data.kundensRef || '';
            document.getElementById('fakturaadresse').value = data.fakturaadresse || '';
            document.getElementById('dato').value = data.dato || '';
            document.getElementById('prosjektnr').value = data.prosjektnr || '';
            document.getElementById('prosjektnavn').value = data.prosjektnavn || '';
            document.getElementById('montor').value = data.montor || '';
            document.getElementById('avdeling').value = data.avdeling || '';
            document.getElementById('sted').value = data.sted || '';
            document.getElementById('signering-dato').value = data.signeringDato || '';
            document.getElementById('kundens-underskrift').value = data.kundensUnderskrift || '';

            const workLines = document.querySelectorAll('.work-line');
            workLines.forEach((line, index) => {
                const lineData = data.workLines && data.workLines[index] ? data.workLines[index] : {};
                const descEl = line.querySelector('.work-description');
                const matEl = line.querySelector('.work-material');
                descEl.value = lineData.description || '';
                matEl.value = lineData.material || '';
                line.querySelector('.work-antall').value = lineData.antall || '';
                line.querySelector('.work-enhet').value = lineData.enhet || '';
                // Resize textareas
                autoResizeTextarea(descEl);
                autoResizeTextarea(matEl);
            });

            // Also sync to mobile form
            syncOriginalToMobile();

            // Show mobile lines that have data
            showMobileLinesWithData();
        }

        function saveForm() {
            const data = getFormData();

            // Sjekk at ordrenummer er fylt ut
            if (!data.ordreseddelNr || data.ordreseddelNr.trim() === '') {
                showNotificationModal('Du må fylle inn ordrenummer før du kan lagre.');
                return;
            }

            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const existingIndex = saved.findIndex(item =>
                item.ordreseddelNr === data.ordreseddelNr
            );

            if (existingIndex !== -1) {
                // Ordrenummer finnes allerede - spør om oppdatering
                showConfirmModal('Dette ordrenummeret finnes allerede. Vil du oppdatere det?', function() {
                    data.id = saved[existingIndex].id;
                    saved[existingIndex] = data;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
                    showNotificationModal('Skjema oppdatert!');
                }, 'Oppdater', '#1abc9c');
            } else {
                // Nytt ordrenummer - vanlig lagring
                showConfirmModal('Er du sikker på at du vil lagre skjemaet?', function() {
                    data.id = Date.now().toString();
                    saved.unshift(data);
                    if (saved.length > 50) saved.pop();
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
                    showNotificationModal('Skjema lagret!');
                }, 'Lagre', '#1abc9c');
            }
        }

        function showSavedForms() {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const listEl = document.getElementById('saved-list');

            if (saved.length === 0) {
                listEl.innerHTML = '<div class="no-saved">Ingen lagrede skjemaer</div>';
            } else {
                listEl.innerHTML = saved.map((item, index) => {
                    const prosjektnavn = item.prosjektnavn || '';
                    const ordrenr = item.ordreseddelNr || '';
                    const oppdragsgiver = item.oppdragsgiver || '';
                    const dato = item.dato || '';
                    const prosjektnr = item.prosjektnr || '';

                    const row1 = [prosjektnavn, oppdragsgiver].filter(x => x).join(' • ') || 'Uten navn';
                    const row2 = [dato, prosjektnr].filter(x => x).join(' • ');
                    const row3 = ordrenr ? `Ordre: ${ordrenr}` : '';

                    return `
                        <div class="saved-item" onclick="loadForm(${index})">
                            <div class="saved-item-info">
                                <div class="saved-item-row1">${row1}</div>
                                ${row2 ? `<div class="saved-item-row2">${row2}</div>` : ''}
                                ${row3 ? `<div class="saved-item-row3">${row3}</div>` : ''}
                            </div>
                            <div class="saved-item-buttons">
                                <button class="saved-item-icon-btn archive" onclick="archiveForm(event, ${index})" title="Arkiver"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z"/></svg></button>
                                <button class="saved-item-icon-btn delete" onclick="deleteForm(event, ${index})" title="Slett"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            document.getElementById('saved-modal').classList.add('active');
        }

        function loadForm(index) {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            if (saved[index]) {
                setFormData(saved[index]);
                closeModal();
            }
        }

        function deleteForm(event, index) {
            event.stopPropagation();
            showConfirmModal('Er du sikker på at du vil slette dette skjemaet?', function() {
                const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                saved.splice(index, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
                showSavedForms();
            });
        }

        function closeModal() {
            document.getElementById('saved-modal').classList.remove('active');
            document.getElementById('saved-search').value = '';
        }

        function filterSavedForms() {
            const searchTerm = document.getElementById('saved-search').value.toLowerCase();
            const items = document.querySelectorAll('#saved-list .saved-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function filterArchivedForms() {
            const searchTerm = document.getElementById('archive-search').value.toLowerCase();
            const items = document.querySelectorAll('#archive-list .saved-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function archiveForm(event, index) {
            event.stopPropagation();
            showConfirmModal('Vil du arkivere dette skjemaet?', function() {
                const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const archived = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');

                const form = saved.splice(index, 1)[0];
                archived.unshift(form);

                localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
                localStorage.setItem(ARCHIVE_KEY, JSON.stringify(archived));

                showSavedForms();
                showNotificationModal('Skjema arkivert!');
            }, 'Arkiver', '#1abc9c');
        }

        function showArchivedForms() {
            const archived = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
            const listEl = document.getElementById('archive-list');

            if (archived.length === 0) {
                listEl.innerHTML = '<div class="no-saved">Ingen arkiverte skjemaer</div>';
            } else {
                listEl.innerHTML = archived.map((item, index) => {
                    const prosjektnavn = item.prosjektnavn || '';
                    const ordrenr = item.ordreseddelNr || '';
                    const oppdragsgiver = item.oppdragsgiver || '';
                    const dato = item.dato || '';
                    const prosjektnr = item.prosjektnr || '';

                    const row1 = [prosjektnavn, oppdragsgiver].filter(x => x).join(' • ') || 'Uten navn';
                    const row2 = [dato, prosjektnr].filter(x => x).join(' • ');
                    const row3 = ordrenr ? `Ordre: ${ordrenr}` : '';

                    return `
                        <div class="saved-item" onclick="loadArchivedForm(${index})">
                            <div class="saved-item-info">
                                <div class="saved-item-row1">${row1}</div>
                                ${row2 ? `<div class="saved-item-row2">${row2}</div>` : ''}
                                ${row3 ? `<div class="saved-item-row3">${row3}</div>` : ''}
                            </div>
                            <div class="saved-item-buttons">
                                <button class="saved-item-icon-btn restore" onclick="restoreForm(event, ${index})" title="Gjenopprett"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg></button>
                                <button class="saved-item-icon-btn delete" onclick="deleteArchivedForm(event, ${index})" title="Slett"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            document.getElementById('archive-modal').classList.add('active');
        }

        function loadArchivedForm(index) {
            const archived = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
            if (archived[index]) {
                setFormData(archived[index]);
                closeArchiveModal();
            }
        }

        function restoreForm(event, index) {
            event.stopPropagation();
            showConfirmModal('Vil du gjenopprette dette skjemaet?', function() {
                const archived = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
                const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

                const form = archived.splice(index, 1)[0];
                saved.unshift(form);

                localStorage.setItem(ARCHIVE_KEY, JSON.stringify(archived));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));

                showArchivedForms();
                showNotificationModal('Skjema gjenopprettet!');
            }, 'Gjenopprett', '#3498db');
        }

        function deleteArchivedForm(event, index) {
            event.stopPropagation();
            showConfirmModal('Er du sikker på at du vil slette dette skjemaet permanent?', function() {
                const archived = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
                archived.splice(index, 1);
                localStorage.setItem(ARCHIVE_KEY, JSON.stringify(archived));
                showArchivedForms();
            });
        }

        function closeArchiveModal() {
            document.getElementById('archive-modal').classList.remove('active');
            document.getElementById('archive-search').value = '';
        }

        function newForm() {
            showConfirmModal('Vil du starte et nytt skjema? Ulagrede endringer vil gå tapt.', function() {
                // Clear all inputs in both forms
                document.querySelectorAll('#form-container input, #form-container textarea').forEach(el => el.value = '');
                document.querySelectorAll('#mobile-form input, #mobile-form textarea').forEach(el => el.value = '');

                // Clear sessionStorage so refresh doesn't restore data
                sessionStorage.removeItem('firesafe_current');

                // Reset mobile lines - only show first line
                const lines = document.querySelectorAll('#mobile-work-lines .mobile-work-line');
                lines.forEach((line, index) => {
                    if (index === 0) {
                        line.classList.add('visible');
                    } else {
                        line.classList.remove('visible');
                    }
                });
                document.querySelector('.mobile-add-line-btn').style.display = 'block';

                // Update delete button states (disable when only 1 line)
                updateDeleteButtonStates();
            }, 'Start ny', '#1abc9c');
        }

        async function exportPDF() {
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                // Sync mobile form to original if on mobile
                if (isMobile()) {
                    syncMobileToOriginal();
                }

                const element = document.getElementById('form-container');

                // Temporarily show form-container at full size for export
                const originalDisplay = element.style.display;
                const originalPosition = element.style.position;
                const originalLeft = element.style.left;
                const originalWidth = element.style.width;

                // First show element with proper width to calculate sizes
                element.style.display = 'block';
                element.style.width = '800px';
                element.style.visibility = 'hidden';
                element.style.position = 'fixed';
                element.style.top = '0';
                element.style.left = '0';

                // Wait for layout to be calculated
                await new Promise(resolve => requestAnimationFrame(() => {
                    requestAnimationFrame(resolve);
                }));

                // Convert textareas to divs for proper text wrapping
                const convertedElements = convertTextareasToDiv();

                // Wait for conversion to take effect
                await new Promise(resolve => requestAnimationFrame(() => {
                    requestAnimationFrame(resolve);
                }));

                // Now move off-screen for capture
                element.style.visibility = 'visible';
                element.style.position = 'absolute';
                element.style.left = '-9999px';
                element.style.top = '';

                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                // Restore textareas
                restoreTextareas(convertedElements);

                // Restore original styles
                element.style.display = originalDisplay;
                element.style.position = originalPosition;
                element.style.left = originalLeft;
                element.style.width = originalWidth;
                element.style.visibility = '';
                element.style.top = '';

                // On mobile, hide it again
                if (isMobile()) {
                    element.style.display = 'none';
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, imgWidth, imgHeight);

                const prosjektnr = document.getElementById('prosjektnr').value || 'ukjent';
                const dato = document.getElementById('dato').value.replace(/\./g, '-') || formatDate(new Date()).replace(/\./g, '-');
                pdf.save(`ordreseddel_${prosjektnr}_${dato}.pdf`);
            } catch (error) {
                alert('Feil ved generering av PDF: ' + error.message);
            } finally {
                loading.classList.remove('active');
            }
        }

        async function exportJPG() {
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                // Sync mobile form to original if on mobile
                if (isMobile()) {
                    syncMobileToOriginal();
                }

                const element = document.getElementById('form-container');

                // Temporarily show form-container at full size for export
                const originalDisplay = element.style.display;
                const originalPosition = element.style.position;
                const originalLeft = element.style.left;
                const originalWidth = element.style.width;

                // First show element with proper width to calculate sizes
                element.style.display = 'block';
                element.style.width = '800px';
                element.style.visibility = 'hidden';
                element.style.position = 'fixed';
                element.style.top = '0';
                element.style.left = '0';

                // Wait for layout to be calculated
                await new Promise(resolve => requestAnimationFrame(() => {
                    requestAnimationFrame(resolve);
                }));

                // Convert textareas to divs for proper text wrapping
                const convertedElements = convertTextareasToDiv();

                // Wait for conversion to take effect
                await new Promise(resolve => requestAnimationFrame(() => {
                    requestAnimationFrame(resolve);
                }));

                // Now move off-screen for capture
                element.style.visibility = 'visible';
                element.style.position = 'absolute';
                element.style.left = '-9999px';
                element.style.top = '';

                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                // Restore textareas
                restoreTextareas(convertedElements);

                // Restore original styles
                element.style.display = originalDisplay;
                element.style.position = originalPosition;
                element.style.left = originalLeft;
                element.style.width = originalWidth;
                element.style.visibility = '';
                element.style.top = '';

                // On mobile, hide it again
                if (isMobile()) {
                    element.style.display = 'none';
                }

                const link = document.createElement('a');
                const prosjektnr = document.getElementById('prosjektnr').value || 'ukjent';
                const dato = document.getElementById('dato').value.replace(/\./g, '-') || formatDate(new Date()).replace(/\./g, '-');
                link.download = `ordreseddel_${prosjektnr}_${dato}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
            } catch (error) {
                alert('Feil ved generering av JPG: ' + error.message);
            } finally {
                loading.classList.remove('active');
            }
        }

        document.getElementById('saved-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('archive-modal').addEventListener('click', function(e) {
            if (e.target === this) closeArchiveModal();
        });

        // Sync forms when typing
        document.getElementById('mobile-form').addEventListener('input', function() {
            syncMobileToOriginal();
            sessionStorage.setItem('firesafe_current', JSON.stringify(getFormData()));
        });

        document.getElementById('form-container').addEventListener('input', function() {
            syncOriginalToMobile();
            sessionStorage.setItem('firesafe_current', JSON.stringify(getFormData()));
        });

        window.addEventListener('load', function() {
            const current = sessionStorage.getItem('firesafe_current');
            if (current) {
                try {
                    const data = JSON.parse(current);
                    if (data.oppdragsgiver || data.prosjektnavn || data.prosjektnr) {
                        setFormData(data);
                    }
                } catch (e) {}
            }
            // Alltid tøm signering-dato og kundens underskrift ved oppstart
            document.getElementById('signering-dato').value = '';
            document.getElementById('kundens-underskrift').value = '';
            document.getElementById('mobile-signering-dato').value = '';
            document.getElementById('mobile-kundens-underskrift').value = '';

            // Initialize auto-resize for textareas
            initAutoResize();

            // Update delete button states
            updateDeleteButtonStates();

            // Scroll fokusert input inn i sikt når mobil-tastatur åpnes
            document.querySelectorAll('#mobile-form input, #mobile-form textarea').forEach(input => {
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
        });
    </script>
</body>
</html>
